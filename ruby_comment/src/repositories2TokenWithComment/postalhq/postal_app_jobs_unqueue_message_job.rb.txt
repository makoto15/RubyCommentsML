if queued_message on_period server on_period UNK on_nl log on_tstring_beg on_embexpr_beg log_prefix on_embexpr_end on_tstring_content on_tstring_end on_nl queued_message on_period message on_period create_delivery # # If the server is suspended, hold all messages #
if queued_message on_period UNK on_op on_const on_period UNK on_period UNK on_period UNK on_nl details on_op on_tstring_beg on_tstring_content on_embexpr_beg queued_message on_period # We might not be able to send this any more, check the attempts
if UNK on_op queued_message on_period UNK on_nl details on_op on_tstring_beg on_tstring_content on_embexpr_beg UNK on_embexpr_end on_tstring_content on_tstring_end on_nl end on_nl UNK # Send bounces to incoming e-mails when they are hard failed
if queued_message on_period server on_period UNK on_period UNK on_period UNK on_lparen on_symbeg UNK on_comma queued_message on_period message on_period rcpt_to on_comma # Add the recipient to the suppression list
UNK queued_message on_period message on_period UNK on_nl log on_tstring_beg on_embexpr_beg log_prefix on_embexpr_end on_tstring_content on_tstring_end on_nl queued_message on_period message on_period create_delivery # If the raw message has been removed (removed by retention)
if queued_message on_period message on_period scope on_op on_tstring_beg on_tstring_content on_tstring_end on_nl if queued_message on_period message on_period UNK on_op on_int on_nl # # Handle Incoming Messages #
if queued_message on_period message on_period UNK on_op on_int on_nl log on_tstring_beg on_embexpr_beg log_prefix on_embexpr_end on_tstring_content on_tstring_end on_nl UNK on_op queued_message # # If this is a bounce, we need to handle it as such #
if queued_message on_period message on_period UNK on_period UNK on_nl log on_tstring_beg on_embexpr_beg log_prefix on_embexpr_end on_tstring_content on_tstring_end on_nl queued_message on_period message # This message was sent to the return path but hasn't been matched # to an original message. If we have a route for this, route it # otherwise we'll drop at this point.
queued_message on_period message on_period UNK on_period UNK on_period UNK on_lparen queued_message on_period message on_period scope on_rparen on_nl on_ignored_nl if queued_message # # Update live stats #
if queued_message on_period message on_period UNK on_op on_int on_nl log on_tstring_beg on_embexpr_beg log_prefix on_embexpr_end on_tstring_content on_tstring_end on_nl queued_message on_period message # # Inspect incoming messages #
if queued_message on_period message on_period spam_score on_op queued_message on_period server on_period UNK on_nl log on_tstring_beg on_embexpr_beg log_prefix on_embexpr_end on_tstring_content on_tstring_end # # If this message has a SPAM score higher than is permitted #
if queued_message on_period server on_period mode on_op on_tstring_beg on_tstring_content on_tstring_end on_op on_op queued_message on_period manual? on_nl log on_tstring_beg on_tstring_content on_tstring_end # If the server is in development mode, hold it
if route on_op queued_message on_period message on_period route on_nl on_ignored_nl if route on_period UNK on_op on_tstring_beg on_tstring_content on_tstring_end on_op queued_message # # Find out what sort of message we're supposed to be sending and dispatch this request over to # the sender. #
if route on_period UNK on_op on_tstring_beg on_tstring_content on_tstring_end on_op queued_message on_period message on_period spam on_op on_int on_op on_op queued_message on_period # If the route says we're holding quananteed mail and this is spam, we'll hold this
if route on_period UNK on_op on_tstring_beg on_tstring_content on_tstring_end on_op queued_message on_period message on_period spam on_op on_int on_op on_op queued_message on_period # If the route says we're holding quananteed mail and this is spam, we'll hold this
if route on_period mode on_op on_tstring_beg on_tstring_content on_tstring_end on_nl queued_message on_period message on_period create_delivery on_lparen on_tstring_beg on_tstring_content on_tstring_end on_comma on_symbeg # # Messages that should be blindly accepted are blindly accepted #
if route on_period mode on_op on_tstring_beg on_tstring_content on_tstring_end on_nl log on_tstring_beg on_embexpr_beg log_prefix on_embexpr_end on_tstring_content on_tstring_end on_nl if queued_message on_period # # Messages that should be accepted and held should be held #
if route on_period mode on_op on_tstring_beg on_tstring_content on_tstring_end on_op route on_period mode on_op on_tstring_beg on_tstring_content on_tstring_end on_nl if id on_op # # Messages that should be bounced should be bounced (or rejected if they got this far) #
UNK on_op result on_period details on_nl if result on_period type on_op on_tstring_beg on_tstring_content on_tstring_end on_op result on_period UNK on_nl log # Log the result
log on_tstring_beg on_embexpr_beg log_prefix on_embexpr_end on_tstring_content on_tstring_end on_nl UNK result on_period type on_op on_tstring_beg on_tstring_content on_tstring_end on_op queued_message on_period message # The delivery hard failed, but requested that no bounce be sent
log on_tstring_beg on_embexpr_beg log_prefix on_embexpr_end on_tstring_content on_tstring_end on_nl if UNK on_op queued_message on_period UNK on_nl UNK on_op on_tstring_beg on_tstring_content on_tstring_end # If the message is a hard fail, send a bounce message for this message.
if queued_message on_period message on_period scope on_op on_tstring_beg on_tstring_content on_tstring_end on_nl if queued_message on_period message on_period UNK on_period UNK on_nl # # Handle Outgoing Messages #
if queued_message on_period message on_period rcpt_to on_period UNK on_nl log on_tstring_beg on_embexpr_beg log_prefix on_embexpr_end on_tstring_content on_tstring_end on_nl queued_message on_period message # # If there's no to address, we can't do much. Fail it. #
if on_op queued_message on_period manual? on_op queued_message on_period message on_period UNK on_op queued_message on_period message on_period UNK on_period UNK on_nl # # If the credentials for this message is marked as holding and this isn't manual, hold it #
if on_op queued_message on_period manual? on_op UNK on_op queued_message on_period server on_period UNK on_period UNK on_period UNK on_lparen on_symbeg UNK # # If the recipient is on the suppression list and this isn't a manual queueing block sending #
if queued_message on_period message on_period UNK on_period UNK on_op UNK on_op queued_message on_period message on_period UNK on_lbracket on_tstring_beg on_tstring_content on_tstring_end # Extract a tag and add it to the message if one doesn't exist
if queued_message on_period message on_period UNK on_nl log on_tstring_beg on_embexpr_beg log_prefix on_embexpr_end on_tstring_content on_tstring_end on_nl queued_message on_period message on_period UNK # Parse the content of the message as appropriate
if queued_message on_period message on_period UNK on_op on_int on_op queued_message on_period server on_period UNK on_nl log on_tstring_beg on_embexpr_beg log_prefix on_embexpr_end # Inspect outgoing messages when there's a threshold set for the server
if on_op queued_message on_period message on_period UNK on_nl queued_message on_period message on_period UNK on_nl end on_nl on_ignored_nl if queued_message on_period # Add outgoing headers
if queued_message on_period server on_period UNK on_nl queued_message on_period server on_period UNK on_lparen on_symbeg UNK on_op on_const on_period UNK on_comma # Check send limits
queued_message on_period server on_period UNK on_lparen on_symbeg UNK on_op on_const on_period UNK on_comma on_symbeg UNK on_op nil on_rparen on_nl queued_message # If we're over the limit, we're going to be holding this message
queued_message on_period server on_period UNK on_lparen on_symbeg UNK on_op on_const on_period UNK on_comma on_symbeg UNK on_op nil on_rparen on_nl else # If we're approaching the limit, just say we are but continue to process the message
queued_message on_period message on_period UNK on_period UNK on_period UNK on_lparen queued_message on_period message on_period scope on_rparen on_nl on_ignored_nl if queued_message # Update the live stats for this message.
if queued_message on_period server on_period mode on_op on_tstring_beg on_tstring_content on_tstring_end on_op on_op queued_message on_period manual? on_nl log on_tstring_beg on_tstring_content on_tstring_end # If the server is in development mode, hold it
begin on_ignored_nl if on_ivar on_nl result on_op on_ivar on_nl else on_ignored_nl sender on_op UNK on_lparen on_const on_op on_const on_comma queued_message # Send the outgoing message to the SMTP sender
if result on_period type on_op on_tstring_beg on_tstring_content on_tstring_end on_nl UNK on_op queued_message on_period server on_period UNK on_period UNK on_lparen on_symbeg # # If the message has been hard failed, check to see how many other recent hard fails we've had for the address # and if there are more than 2, suppress the address for 30 days. #
if result on_period type on_op on_tstring_beg on_tstring_content on_tstring_end on_nl if queued_message on_period server on_period UNK on_period UNK on_period UNK on_lparen # # If a message is sent successfully, remove the users from the suppression list #
queued_message on_period message on_period create_delivery on_lparen result on_period type on_comma on_symbeg details on_op result on_period details on_comma on_symbeg UNK on_op # Log the result
